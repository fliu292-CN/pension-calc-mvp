<page-meta page-style="overflow: {{ showCity ? 'hidden' : 'visible' }}" />

<van-toast id="van-toast" />

<view class="page-wrapper {{ isLyingFlat ? 'theme-orange' : 'theme-indigo' }}">
  <!-- 背景色块 -->
  <view class="bg-layer"></view>
  
  <view class="content-layer">
    <!-- 头部区域 -->
    <view class="header-section">
      <view class="main-title">提前躺平计算器</view>
      <view class="sub-title">{{ isLyingFlat ? '告别内卷 · 精算你的自由成本' : '规划稳健未来，享受长青人生' }}</view>
    </view>

    <!-- 模式切换器 -->
    <view class="switcher-container">
      <view class="switcher-bg">
        <view class="switch-btn {{ !isLyingFlat ? 'active-normal' : '' }}" bindtap="toggleMode" data-mode="normal">
          <van-icon name="bag-o" size="16px" /> 正常退休
        </view>
        <view class="switch-btn {{ isLyingFlat ? 'active-early' : '' }}" bindtap="toggleMode" data-mode="flat">
          <van-icon name="free-postage" size="16px" /> 提前躺平
        </view>
      </view>
    </view>

    <!-- 表单卡片 -->
    <view class="form-card">
      <van-cell-group border="{{ false }}">
        <van-cell title="参保城市" value="{{ city }}" is-link bind:click="showCityPopup" icon="location-o" border="{{ false }}" />

        <van-cell title="性别" icon="contact" border="{{ false }}">
          <van-radio-group value="{{ gender }}" direction="horizontal" bind:change="onGenderChange">
            <van-radio name="male" checked-color="{{ isLyingFlat ? '#f97316' : '#4f46e5' }}">男</van-radio>
            <van-radio name="female" checked-color="{{ isLyingFlat ? '#f97316' : '#4f46e5' }}">女</van-radio>
          </van-radio-group>
        </van-cell>

        <van-field label="当前年龄" value="{{ age }}" type="number" input-align="right" bind:change="onAgeChange" left-icon="clock-o" border="{{ false }}">
          <view slot="button" class="unit-text">岁</view>
        </van-field>

        <van-field label="退休年龄" value="{{ retireAge }}" type="number" input-align="right" bind:change="onRetireAgeChange" left-icon="flag-o" border="{{ false }}">
          <view slot="button" class="unit-text">岁</view>
        </van-field>

        <van-field 
          value="{{ years }}" 
          type="number" 
          input-align="right" 
          bind:change="onYearsChange" 
          left-icon="chart-trending-o"
          border="{{ false }}"
          use-label-slot
          label-width="110px"
        >
          <view slot="label" class="custom-label">
            <text>已缴年限</text>
            <van-icon name="question-o" class="help-icon" catch:tap="onShowYearsHelp" />
          </view>
          <view slot="button" class="unit-text">年</view>
        </van-field>

        <van-field label="账户余额" value="{{ balance }}" type="number" input-align="right" bind:change="onBalanceChange" left-icon="gold-coin-o" border="{{ false }}">
          <view slot="button" class="unit-text">元</view>
        </van-field>

        <block wx:if="{{ isLyingFlat }}">
          <view class="custom-level-section">
            <view class="level-header">
              <view class="level-icon-wrap">
                <van-icon name="gem-o" size="20px" />
              </view>
              <text class="level-title">缴费档次</text>
            </view>
            <view class="level-options">
              <view class="level-btn {{ flatInvestmentRate === '0.6' ? 'active' : '' }}" bindtap="onFlatRateClick" data-rate="0.6">60%</view>
              <view class="level-btn {{ flatInvestmentRate === '1.0' ? 'active' : '' }}" bindtap="onFlatRateClick" data-rate="1.0">100%</view>
              <view class="level-btn {{ flatInvestmentRate === '3.0' ? 'active' : '' }}" bindtap="onFlatRateClick" data-rate="3.0">300%</view>
            </view>
          </view>
          <view class="flat-cost-tip">
            <van-icon name="info-o" /> 当前档位每月自缴约：<text class="highlight">¥{{ monthlyFlatCost }}</text>
          </view>
        </block>

        <block wx:else>
          <van-field label="税前月薪" value="{{ salary }}" type="number" input-align="right" bind:change="onSalaryChange" left-icon="balance-list-o" border="{{ false }}">
            <view slot="button" class="unit-text">元</view>
          </van-field>

          <van-cell center title="开启涨薪预测 (年涨3%)" border="{{ false }}" icon="ascending">
            <van-switch slot="right-icon" checked="{{ useGrowth }}" bind:change="onGrowthChange" size="24px" active-color="#4f46e5" />
          </van-cell>
        </block>
      </van-cell-group>
    </view>

    <!-- 结果卡片展示 -->
    <view wx:if="{{ result }}" class="result-display-card {{ isLyingFlat ? 'flat-result' : 'normal-result' }}" id="result-section">
      
      <!-- 躺平模式：增加收支对比看板 -->
      <view wx:if="{{ isLyingFlat }}" class="flat-balance-board">
        <view class="balance-side outflow">
          <text class="b-label">躺平总投入</text>
          <text class="b-value">¥{{ result.detail.total_cost }}</text>
          <text class="b-sub">从现在缴到退休</text>
        </view>
        <view class="balance-divider">
          <view class="vs-circle">VS</view>
        </view>
        <view class="balance-side inflow">
          <text class="b-label">可领失业金</text>
          <text class="b-value">¥{{ result.detail.unemployment_benefit }}</text>
          <text class="b-sub">预计领{{ result.detail.unemployment_months }}个月</text>
        </view>
      </view>

      <view class="result-header">
        <text class="result-label">{{ isLyingFlat ? '退休后的“自由金”' : '退休后月领金额' }}</text>
        <view class="result-main-amount">
          <text class="currency">¥</text>
          <text class="amount-val">{{ result.detail.total_pension }}</text>
        </view>
      </view>

      <view class="result-grid">
        <view class="grid-item">
          <text class="grid-label">基础养老金</text>
          <text class="grid-value">¥{{ result.detail.basic_pension }}</text>
        </view>
        <view class="grid-item">
          <text class="grid-label">账户养老金</text>
          <text class="grid-value">¥{{ result.detail.account_pension }}</text>
        </view>
      </view>

      <view class="analysis-box">
        <view class="analysis-title">精算师解读</view>
        <view class="analysis-content">
          <block wx:for="{{ processText }}" wx:key="index">
            <view class="analysis-p">{{ item }}</view>
          </block>
        </view>
      </view>
    </view>

    <view class="footer-tips">
      免责声明：本计算结果基于现有政策估算，仅供参考。实际金额以社保局核算为准。
    </view>

  </view>
</view>

<!-- 城市选择 -->
<van-popup 
  show="{{ showCity }}" 
  position="bottom" 
  round 
  bind:close="onCityCancel"
  lock-scroll="{{ true }}"
>
  <van-picker 
    wx:if="{{ showCity }}" 
    show-toolbar 
    title="选择地区" 
    columns="{{ cityColumns }}" 
    default-index="{{ defaultCityIndex }}" 
    item-height="{{ 50 }}"
    visible-item-count="{{ 5 }}"
    bind:cancel="onCityCancel" 
    bind:confirm="onCityConfirm" 
  />
</van-popup>

<!-- 吸底按钮面板 -->
<view class="action-panel">
  <view class="action-btn {{ isLyingFlat ? 'btn-orange' : 'btn-indigo' }}" bindtap="onSubmit">
    {{ isLyingFlat ? '测算自由成本' : '开始精算' }}
  </view>
</view>
